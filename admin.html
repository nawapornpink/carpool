<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>Carpool (Admin)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f5f5f7;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .app-shell {
            max-width: 1200px;
            margin: 24px auto 40px;
        }

        .card-ios {
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
            border: none;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 16px;
        }

        .badge-role {
            border-radius: 999px;
            padding: 2px 10px;
            font-size: .75rem;
        }

        .badge-role-emp {
            background-color: #e5f2ff;
            color: #0a84ff;
        }

        .badge-role-admin {
            background-color: #fef0d2;
            color: #ff9500;
        }

        .status-pill {
            padding: 2px 10px;
            border-radius: 999px;
            font-size: .75rem;
            color: #fff;
        }

        .status-using {
            background-color: #ff9f0a;
        }

        .status-done {
            background-color: #34c759;
        }

        .btn-pill {
            border-radius: 999px;
        }

        .table thead th {
            background-color: #f2f2f7;
            border-bottom-width: 0;
        }

        .color-swatch {
            width: 26px;
            height: 18px;
            border-radius: 999px;
            border: 1px solid rgba(0, 0, 0, .15);
        }
    </style>
</head>

<body>
    <div class="app-shell">

        <!-- NAVBAR -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3 rounded-3">
            <div class="container-fluid">
                <a class="navbar-brand fw-semibold" href="#">Carpool (Admin)</a>
                <div class="navbar-nav">
                    <a class="nav-link active" href="#" data-section-target="section-dashboard">ภาพรวม</a>
                    <a class="nav-link" href="#" data-section-target="section-cars">จัดการรถ</a>
                    <a class="nav-link" href="#" data-section-target="section-users">จัดการผู้ใช้งาน</a>
                    <a class="nav-link" href="#" data-section-target="section-borrows">รายการยืมรถ</a>
                    <a class="nav-link" href="#" data-section-target="section-fuels">รายการเติมน้ำมัน</a>
                    <a class="nav-link" href="#" data-section-target="section-summary">สรุปค่าน้ำมัน/เลขไมล์</a>
                    <!-- logout -->
                    <a class="nav-link ms-lg-3" href="#" id="logoutLink">ออกจากระบบ</a>
                </div>
            </div>
        </nav>

        <!-- ============ SECTION: ภาพรวม ============ -->
        <section id="section-dashboard" class="app-section">
            <h3 class="section-title">ภาพรวมระบบ</h3>

            <div class="row g-3 mb-3">
                <div class="col-md-3 col-6">
                    <div class="card card-ios">
                        <div class="card-body">
                            <div class="text-muted small mb-1">จำนวนรถทั้งหมด</div>
                            <div class="fs-3 fw-semibold" id="dashTotalCars">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card card-ios">
                        <div class="card-body">
                            <div class="text-muted small mb-1">รถที่กำลังใช้งาน</div>
                            <div class="fs-3 fw-semibold" id="dashUsingCars">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card card-ios">
                        <div class="card-body">
                            <div class="text-muted small mb-1">จำนวนผู้ใช้งาน</div>
                            <div class="fs-3 fw-semibold" id="dashUsers">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card card-ios">
                        <div class="card-body">
                            <div class="text-muted small mb-1">รายการเติมน้ำมัน</div>
                            <div class="fs-3 fw-semibold" id="dashFuelCount">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card card-ios">
                <div class="card-body">
                    <h6 class="mb-3">ตัวอย่างรายการยืมรถล่าสุด</h6>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>เลข ยพ.</th>
                                    <th>ทะเบียนรถ</th>
                                    <th>ผู้ยืม</th>
                                    <th>วันที่ไป</th>
                                    <th>วันที่กลับ</th>
                                    <th>สถานที่</th>
                                    <th>สถานะ</th>
                                </tr>
                            </thead>
                            <tbody id="dashBorrowTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============ SECTION: จัดการรถ ============ -->
        <section id="section-cars" class="app-section d-none">
            <h3 class="section-title">จัดการข้อมูลรถ</h3>

            <!-- ฟอร์มแบ่ง 2 คอลัมน์ให้ดูบาลานซ์ -->
            <div class="card card-ios mb-3">
                <div class="card-body">
                    <h6 class="mb-3">เพิ่ม / แก้ไขข้อมูลรถ</h6>
                    <form id="carForm" class="row g-3">
                        <input type="hidden" id="carIndex">

                        <!-- คอลัมน์ซ้าย -->
                        <div class="col-md-6">
                            <div class="row g-3">
                                <div class="col-4">
                                    <label class="form-label">หมวดอักษร</label>
                                    <input type="text" id="carPrefix" class="form-control" placeholder="เช่น งค">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">เลขทะเบียน</label>
                                    <input type="text" id="carNumber" class="form-control" placeholder="เช่น 3814">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">จังหวัด</label>
                                    <input type="text" id="carProvince" class="form-control" placeholder="เช่น ขก">
                                </div>

                                <div class="col-6">
                                    <label class="form-label">ยี่ห้อ</label>
                                    <input type="text" id="carBrand" class="form-control" placeholder="เช่น ISUZU">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">รุ่น</label>
                                    <input type="text" id="carModel" class="form-control" placeholder="เช่น D-MAX">
                                </div>

                                <div class="col-4">
                                    <label class="form-label">จำนวนที่นั่ง</label>
                                    <input type="number" id="carSeats" class="form-control" min="1" value="5">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">เกียร์</label>
                                    <select id="carGear" class="form-select">
                                        <option>อัตโนมัติ</option>
                                        <option>ธรรมดา</option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <label class="form-label">รูปแบบรถ</label>
                                    <select id="carType" class="form-select">
                                        <option>รถเช่า กฟฉ.1</option>
                                        <option>รถประจำหน่วยงาน</option>
                                        <option>รถส่วนกลาง</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- คอลัมน์ขวา -->
                        <div class="col-md-6">
                            <div class="row g-3">
                                <div class="col-6">
                                    <label class="form-label">เลขไมล์ปัจจุบัน</label>
                                    <input type="number" id="carMileage" class="form-control" min="0">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">สถานะ</label>
                                    <select id="carStatus" class="form-select">
                                        <option>พร้อมใช้งาน</option>
                                        <option>กำลังใช้งาน</option>
                                        <option>อยู่ระหว่างซ่อมบำรุง</option>
                                    </select>
                                </div>

                                <div class="col-6">
                                    <label class="form-label">สีที่ใช้ในปฏิทิน</label>
                                    <!-- จานสี -->
                                    <input type="color" id="carColorPicker" class="form-control form-control-color"
                                        value="#4a90e2" title="เลือกสี">
                                </div>
                                <div class="col-6 d-flex align-items-end gap-2">
                                    <div>
                                        <div class="small text-muted">ตัวอย่างสี</div>
                                        <span class="color-swatch" id="carColorPreview"></span>
                                    </div>
                                    <div class="small text-muted">
                                        ใช้แทนสีของรถคันนี้<br>ในปฏิทินการจอง
                                    </div>
                                </div>

                                <div class="col-12 d-flex justify-content-end gap-2 mt-2">
                                    <button type="button" class="btn btn-outline-secondary btn-pill"
                                        id="carResetBtn">ล้างฟอร์ม</button>
                                    <button type="submit" class="btn btn-primary btn-pill">บันทึกข้อมูลรถ</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ตารางรถ -->
            <div class="card card-ios">
                <div class="card-body">
                    <h6 class="mb-3">รายการรถทั้งหมด</h6>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle" id="carTable">
                            <thead>
                                <tr>
                                    <th>ทะเบียนรถ</th>
                                    <th>ยี่ห้อ / รุ่น</th>
                                    <th>ที่นั่ง</th>
                                    <th>เลขไมล์</th>
                                    <th>รูปแบบ</th>
                                    <th>สถานะ</th>
                                    <th>สีปฏิทิน</th>
                                    <th>การจัดการ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============ SECTION อื่น ๆ (เหมือนเดิม) ============ -->

        <section id="section-users" class="app-section d-none">
            <h3 class="section-title">จัดการผู้ใช้งาน</h3>
            <div class="card card-ios mb-3">
                <div class="card-body">
                    <h6 class="mb-3">เพิ่ม / แก้ไขผู้ใช้งาน</h6>
                    <form id="userForm" class="row g-3">
                        <input type="hidden" id="userIndex">
                        <div class="col-md-3">
                            <label class="form-label">รหัสพนักงาน</label>
                            <input type="text" id="userCode" class="form-control" placeholder="เช่น EMP011">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ชื่อ–สกุล</label>
                            <input type="text" id="userName" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">หน่วยงาน</label>
                            <input type="text" id="userDept" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">บทบาท</label>
                            <select id="userRole" class="form-select">
                                <option value="emp">พนักงาน</option>
                                <option value="admin">ธุรการ/แอดมิน</option>
                            </select>
                        </div>
                        <div class="col-12 d-flex justify-content-end gap-2 mt-2">
                            <button type="button" class="btn btn-outline-secondary btn-pill"
                                id="userResetBtn">ล้างฟอร์ม</button>
                            <button type="submit" class="btn btn-primary btn-pill">บันทึกผู้ใช้งาน</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card card-ios">
                <div class="card-body">
                    <h6 class="mb-3">รายการผู้ใช้งาน</h6>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle" id="userTable">
                            <thead>
                                <tr>
                                    <th>รหัสพนักงาน</th>
                                    <th>ชื่อ–สกุล</th>
                                    <th>หน่วยงาน</th>
                                    <th>บทบาท</th>
                                    <th>การจัดการ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="section-borrows" class="app-section d-none">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h3 class="section-title mb-0">รายการยืมรถ (จากฝั่งผู้ใช้งาน)</h3>
                <button class="btn btn-outline-danger btn-sm" id="clearBorrowBtn">ล้างข้อมูลรายการทั้งหมด</button>
            </div>
            <div class="card card-ios">
                <div class="card-body table-responsive">
                    <table class="table table-sm align-middle" id="borrowTable">
                        <thead>
                            <tr>
                                <th>เลข ยพ.</th>
                                <th>ทะเบียนรถ</th>
                                <th>ผู้ยืม</th>
                                <th>วันที่เริ่ม</th>
                                <th>วันที่สิ้นสุด</th>
                                <th>เลขไมล์ออก</th>
                                <th>เลขไมล์กลับ</th>
                                <th>สถานะ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="section-fuels" class="app-section d-none">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h3 class="section-title mb-0">รายการเติมน้ำมัน</h3>
                <button class="btn btn-outline-danger btn-sm" id="clearFuelBtn">ล้างข้อมูลรายการทั้งหมด</button>
            </div>
            <div class="card card-ios">
                <div class="card-body table-responsive">
                    <table class="table table-sm" id="fuelTable">
                        <thead>
                            <tr>
                                <th>วันที่</th>
                                <th>ทะเบียนรถ</th>
                                <th>เลข ยพ.</th>
                                <th>เลขไมล์</th>
                                <th>ราคาต่อลิตร</th>
                                <th>จำนวนลิตร</th>
                                <th>ราคารวม</th>
                                <th>สถานที่</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="section-summary" class="app-section d-none">
            <h3 class="section-title">สรุปค่าน้ำมันและเลขไมล์รายเดือน</h3>
            <div class="card card-ios mb-3">
                <div class="card-body">
                    <div class="d-flex flex-wrap align-items-end gap-2 mb-3">
                        <div>
                            <label class="form-label small mb-1">เลือกเดือน/ปี</label>
                            <input type="month" id="summaryMonth" class="form-control" style="max-width:260px;">
                        </div>
                        <button class="btn btn-primary btn-pill" id="summaryBtn">ดูสรุป</button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm" id="summaryTable">
                            <thead>
                                <tr>
                                    <th>ทะเบียนรถ</th>
                                    <th>เลขไมล์ต้นเดือน</th>
                                    <th>เลขไมล์ปลายเดือน*</th>
                                    <th>ระยะทางรวมโดยประมาณ</th>
                                    <th>ปริมาณน้ำมันรวม (ลิตร)</th>
                                    <th>ค่าน้ำมันรวม (บาท)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <small class="text-muted">
                        * ใช้เลขไมล์จากการเติมน้ำมันครั้งแรก/ครั้งสุดท้ายของเดือนเพื่อประเมิน
                    </small>
                </div>
            </div>
        </section>

    </div>

    <script>
        // ===== ตรวจสอบ Login + Role =====
        const sessionRole = localStorage.getItem("role");
        if (!sessionRole) {
            window.location.href = "login.html";
        } else if (sessionRole !== "admin") {
            window.location.href = "carpool_user.html";
        }

        // ===== DATA MOCK =====
        function plateOf(car) { return `${car.prefix}-${car.number} ${car.province}`; }

        let cars = [
            { prefix: "งค", number: "3814", province: "ขก", seats: 5, brand: "ISUZU", model: "D-MAX", gear: "อัตโนมัติ", type: "รถเช่า กฟฉ.1", mileage: 86418, status: "พร้อมใช้งาน", color: "#4a90e2" },
            { prefix: "งค", number: "3806", province: "ขก", seats: 5, brand: "ISUZU", model: "D-MAX", gear: "อัตโนมัติ", type: "รถเช่า กฟฉ.1", mileage: 47014, status: "พร้อมใช้งาน", color: "#2ecc71" },
            { prefix: "3ขพ", number: "6247", province: "กทม", seats: 5, brand: "Toyota", model: "REVO", gear: "อัตโนมัติ", type: "รถเช่า กฟฉ.1", mileage: 48120, status: "พร้อมใช้งาน", color: "#e67e22" },
            { prefix: "3ขพ", number: "6250", province: "กทม", seats: 5, brand: "Toyota", model: "REVO", gear: "อัตโนมัติ", type: "รถเช่า กฟฉ.1", mileage: 128237, status: "พร้อมใช้งาน", color: "#9b59b6" },
            { prefix: "ขว", number: "6808", province: "ขก", seats: 5, brand: "ISUZU", model: "DOUBLE CAB", gear: "อัตโนมัติ", type: "รถเช่า กฟฉ.1", mileage: 101769, status: "กำลังใช้งาน", color: "#f1c40f" },
            { prefix: "ขว", number: "6800", province: "ขก", seats: 5, brand: "ISUZU", model: "DOUBLE CAB", gear: "อัตโนมัติ", type: "รถเช่า กฟฉ.1", mileage: 98700, status: "พร้อมใช้งาน", color: "#1abc9c" },
            { prefix: "1ขญ", number: "206", province: "กทม", seats: 7, brand: "ISUZU", model: "MU-X", gear: "อัตโนมัติ", type: "รถเช่า กฟฉ.1", mileage: 124569, status: "พร้อมใช้งาน", color: "#e84393" },
            { prefix: "ขว", number: "6809", province: "ขก", seats: 5, brand: "ISUZU", model: "DOUBLE CAB", gear: "อัตโนมัติ", type: "รถเช่า กฟฉ.1", mileage: 112300, status: "พร้อมใช้งาน", color: "#d35400" }
        ];


        let users = [
            { code: "EMP001", name: "นางสาว สุทธาสินี แก้วมณี", dept: "กดส. ฉ1", role: "emp" },
            { code: "EMP002", name: "นาย ภคิน พันธ์ดี", dept: "กดส. ฉ1", role: "emp" },
            { code: "EMP003", name: "นางสาว ชญานิษฐ์ นาคำ", dept: "กองบริหารงานทั่วไป", role: "emp" },
            { code: "EMP004", name: "นาย ธราเทพ ศูนย์รถ", dept: "กองบริหารงานทั่วไป", role: "admin" },
            { code: "EMP005", name: "นางสาว ณัฐกานต์ ศรีบุญเรือง", dept: "กดส. ฉ1", role: "emp" },
            { code: "EMP006", name: "นาย พิสิษฐ์ กองงาน", dept: "กดส. ฉ1", role: "emp" },
            { code: "EMP007", name: "นางสาว ชลธิชา พรหมมา", dept: "กดส. ฉ1", role: "emp" },
            { code: "EMP008", name: "นาย กิตติธัช วัฒนชัย", dept: "กดส. ฉ1", role: "emp" },
            { code: "EMP009", name: "นางสาว วราภรณ์ จันทร์ดี", dept: "กดส. ฉ1", role: "emp" },
            { code: "EMP010", name: "นาย นวพล อินทรา", dept: "กดส. ฉ1", role: "emp" }
        ];


        let borrows = [
            {
                id: 1,
                ypNo: "ยพ.3814-001",
                plate: "งค-3814 ขก",
                user: "นาย กิตติธัช วัฒนชัย",
                start: "2025-12-02",
                end: "2025-12-02",
                destination: "ออกตรวจงานสถานีไฟฟ้าย่อย กฟฉ.1",
                startMileage: 82950,
                endMileage: 83060,
                status: "done"
            },
            {
                id: 2,
                ypNo: "ยพ.3806-001",
                plate: "งค-3806 ขก",
                user: "นางสาว ชญานิษฐ์ นาคำ",
                start: "2025-12-05",
                end: "2025-12-06",
                destination: "ประชุมโครงการดิจิทัล กฟฟ.เมืองอุดรธานี",
                startMileage: 47014,
                endMileage: 47210,
                status: "done"
            },
            {
                id: 3,
                ypNo: "ยพ.6247-001",
                plate: "3ขพ-6247 กทม",
                user: "นางสาว สุทธาสินี แก้วมณี",
                start: "2025-12-08",
                end: "2025-12-09",
                destination: "ลงพื้นที่สำรวจระบบสื่อสารเชื่อมโยงสถานีไฟฟ้า",
                startMileage: 48120,
                endMileage: 48410,
                status: "done"
            },
            {
                id: 4,
                ypNo: "ยพ.6250-001",
                plate: "3ขพ-6250 กทม",
                user: "นาย ภคิน พันธ์ดี",
                start: "2025-12-15",
                end: "2025-12-15",
                destination: "ติดตามงานติดตั้งระบบเครือข่ายสำนักงานย่อย",
                startMileage: 128237,
                status: "using"
            },
            {
                id: 5,
                ypNo: "ยพ.6808-001",
                plate: "ขว-6808 ขก",
                user: "นางสาว ชลธิชา พรหมมา",
                start: "2025-12-18",
                end: "2025-12-19",
                destination: "ตรวจสภาพเสาไฟและอุปกรณ์สื่อสารในพื้นที่ชนบท",
                startMileage: 101769,
                status: "using"
            },
            {
                id: 6,
                ypNo: "ยพ.1206-001",
                plate: "1ขญ-206 กทม",
                user: "นางสาว ณัฐกานต์ ศรีบุญเรือง",
                start: "2025-12-20",
                end: "2025-12-21",
                destination: "ประชุมเชิงปฏิบัติการ กฟภ.ส่วนกลาง",
                startMileage: 124569,
                endMileage: 125380,
                status: "done"
            }
        ];


        // ===== NAV =====
        const navLinks = document.querySelectorAll("[data-section-target]");
        function showSection(id) {
            document.querySelectorAll(".app-section").forEach(sec => sec.classList.add("d-none"));
            document.getElementById(id).classList.remove("d-none");
            navLinks.forEach(a => a.classList.remove("active"));
            document.querySelector(`[data-section-target="${id}"]`).classList.add("active");
        }
        navLinks.forEach(a => {
            a.addEventListener("click", e => {
                e.preventDefault();
                showSection(a.dataset.sectionTarget);
            });
        });

        // ===== Dashboard =====
        function renderDashboard() {
            document.getElementById("dashTotalCars").textContent = cars.length;
            document.getElementById("dashUsers").textContent = users.length;
            document.getElementById("dashFuelCount").textContent = fuels.length;
            document.getElementById("dashUsingCars").textContent =
                borrows.filter(b => b.status === "using").length;

            const tbody = document.getElementById("dashBorrowTable");
            tbody.innerHTML = "";
            borrows.slice().reverse().slice(0, 5).forEach(b => {
                const statusClass = b.status === "using" ? "status-using" : "status-done";
                const statusText = b.status === "using" ? "กำลังใช้งาน" : "คืนแล้ว";
                tbody.innerHTML += `
                <tr>
                    <td>${b.ypNo}</td>
                    <td>${b.plate}</td>
                    <td>${b.user}</td>
                    <td>${b.start}</td>
                    <td>${b.end}</td>
                    <td>${b.destination || "-"}</td>
                    <td><span class="status-pill ${statusClass}">${statusText}</span></td>
                </tr>`;
            });
        }

        // ===== Cars =====
        const carTableBody = document.querySelector("#carTable tbody");
        const carColorPicker = document.getElementById("carColorPicker");
        const carColorPreview = document.getElementById("carColorPreview");

        function renderCarTable() {
            carTableBody.innerHTML = "";
            cars.forEach((c, idx) => {
                carTableBody.innerHTML += `
                <tr>
                    <td>${plateOf(c)}</td>
                    <td>${c.brand} ${c.model}</td>
                    <td>${c.seats}</td>
                    <td>${c.mileage.toLocaleString()}</td>
                    <td>${c.type}</td>
                    <td>${c.status}</td>
                    <td><span class="color-swatch" style="background:${c.color}"></span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editCar(${idx})">แก้ไข</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCar(${idx})">ลบ</button>
                    </td>
                </tr>`;
            });
        }

        function resetCarForm() {
            document.getElementById("carForm").reset();
            document.getElementById("carIndex").value = "";
            carColorPicker.value = "#4a90e2";
            carColorPreview.style.background = "#4a90e2";
        }

        window.editCar = function (idx) {
            const c = cars[idx];
            document.getElementById("carIndex").value = idx;
            document.getElementById("carPrefix").value = c.prefix;
            document.getElementById("carNumber").value = c.number;
            document.getElementById("carProvince").value = c.province;
            document.getElementById("carSeats").value = c.seats;
            document.getElementById("carBrand").value = c.brand;
            document.getElementById("carModel").value = c.model;
            document.getElementById("carGear").value = c.gear;
            document.getElementById("carType").value = c.type;
            document.getElementById("carMileage").value = c.mileage;
            document.getElementById("carStatus").value = c.status;
            carColorPicker.value = c.color;
            carColorPreview.style.background = c.color;
        };

        window.deleteCar = function (idx) {
            if (!confirm("ต้องการลบข้อมูลรถคันนี้หรือไม่")) return;
            cars.splice(idx, 1);
            renderCarTable();
            renderDashboard();
        };

        document.getElementById("carForm").addEventListener("submit", e => {
            e.preventDefault();
            const idx = document.getElementById("carIndex").value;
            const carData = {
                prefix: document.getElementById("carPrefix").value || "",
                number: document.getElementById("carNumber").value || "",
                province: document.getElementById("carProvince").value || "",
                seats: parseInt(document.getElementById("carSeats").value || "5", 10),
                brand: document.getElementById("carBrand").value || "",
                model: document.getElementById("carModel").value || "",
                gear: document.getElementById("carGear").value,
                type: document.getElementById("carType").value,
                mileage: parseInt(document.getElementById("carMileage").value || "0", 10),
                status: document.getElementById("carStatus").value,
                color: carColorPicker.value || "#4a90e2"
            };
            if (idx === "") cars.push(carData); else cars[idx] = carData;
            resetCarForm();
            renderCarTable();
            renderDashboard();
        });

        document.getElementById("carResetBtn").addEventListener("click", resetCarForm);
        carColorPicker.addEventListener("input", () => carColorPreview.style.background = carColorPicker.value);

        // ===== Users =====
        const userTableBody = document.querySelector("#userTable tbody");
        function renderUserTable() {
            userTableBody.innerHTML = "";
            users.forEach((u, idx) => {
                const roleClass = u.role === "admin" ? "badge-role-admin" : "badge-role-emp";
                const roleText = u.role === "admin" ? "ธุรการ/แอดมิน" : "พนักงาน";
                userTableBody.innerHTML += `
                <tr>
                    <td>${u.code}</td>
                    <td>${u.name}</td>
                    <td>${u.dept}</td>
                    <td><span class="badge-role ${roleClass}">${roleText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${idx})">แก้ไข</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${idx})">ลบ</button>
                    </td>
                </tr>`;
            });
        }
        window.editUser = function (idx) {
            const u = users[idx];
            document.getElementById("userIndex").value = idx;
            document.getElementById("userCode").value = u.code;
            document.getElementById("userName").value = u.name;
            document.getElementById("userDept").value = u.dept;
            document.getElementById("userRole").value = u.role;
        };
        window.deleteUser = function (idx) {
            if (!confirm("ต้องการลบผู้ใช้งานนี้หรือไม่")) return;
            users.splice(idx, 1);
            renderUserTable();
            renderDashboard();
        };
        document.getElementById("userForm").addEventListener("submit", e => {
            e.preventDefault();
            const idx = document.getElementById("userIndex").value;
            const userData = {
                code: document.getElementById("userCode").value || "",
                name: document.getElementById("userName").value || "",
                dept: document.getElementById("userDept").value || "",
                role: document.getElementById("userRole").value
            };
            if (idx === "") users.push(userData); else users[idx] = userData;
            document.getElementById("userForm").reset();
            document.getElementById("userIndex").value = "";
            renderUserTable();
            renderDashboard();
        });
        document.getElementById("userResetBtn").addEventListener("click", () => {
            document.getElementById("userForm").reset();
            document.getElementById("userIndex").value = "";
        });

        // ===== Borrows =====
        const borrowTableBody = document.querySelector("#borrowTable tbody");
        function renderBorrowTable() {
            borrowTableBody.innerHTML = "";
            borrows.forEach(b => {
                const statusClass = b.status === "using" ? "status-using" : "status-done";
                const statusText = b.status === "using" ? "กำลังใช้งาน" : "คืนแล้ว";
                borrowTableBody.innerHTML += `
                <tr>
                    <td>${b.ypNo}</td>
                    <td>${b.plate}</td>
                    <td>${b.user}</td>
                    <td>${b.start}</td>
                    <td>${b.end}</td>
                    <td>${b.startMileage?.toLocaleString() || "-"}</td>
                    <td>${b.endMileage?.toLocaleString() || "-"}</td>
                    <td><span class="status-pill ${statusClass}">${statusText}</span></td>
                </tr>`;
            });
        }
        document.getElementById("clearBorrowBtn").addEventListener("click", () => {
            if (!confirm("ลบรายการยืมรถทั้งหมดในตัวอย่างนี้หรือไม่")) return;
            borrows = [];
            renderBorrowTable();
            renderDashboard();
        });

        // ===== Fuels =====
        const fuelTableBody = document.querySelector("#fuelTable tbody");
        function renderFuelTable() {
            fuelTableBody.innerHTML = "";
            fuels.forEach(f => {
                fuelTableBody.innerHTML += `
                <tr>
                    <td>${f.date}</td>
                    <td>${f.plate}</td>
                    <td>${f.ypNo}</td>
                    <td>${f.mileage.toLocaleString()}</td>
                    <td>${f.pricePerLitre.toFixed(2)}</td>
                    <td>${f.litre.toFixed(2)}</td>
                    <td>${f.total.toFixed(2)}</td>
                    <td>${f.place}</td>
                </tr>`;
            });
        }
        document.getElementById("clearFuelBtn").addEventListener("click", () => {
            if (!confirm("ลบรายการเติมน้ำมันทั้งหมดในตัวอย่างนี้หรือไม่")) return;
            fuels = [];
            renderFuelTable();
            renderDashboard();
        });

        // ===== Summary =====
        const summaryTableBody = document.querySelector("#summaryTable tbody");
        document.getElementById("summaryBtn").addEventListener("click", () => {
            const mv = document.getElementById("summaryMonth").value;
            if (!mv) { alert("กรุณาเลือกเดือน/ปี"); return; }
            const [y, m] = mv.split("-").map(n => parseInt(n, 10));
            summaryTableBody.innerHTML = "";
            const plates = [...new Set(fuels.map(f => f.plate))];
            plates.forEach(plate => {
                const list = fuels.filter(f => {
                    const [yy, mm] = f.date.split("-").map(n => parseInt(n, 10));
                    return yy === y && mm === m && f.plate === plate;
                });
                if (!list.length) return;
                const firstM = list[0].mileage;
                const lastM = list[list.length - 1].mileage;
                const dist = lastM - firstM;
                const litreSum = list.reduce((s, f) => s + f.litre, 0);
                const costSum = list.reduce((s, f) => s + f.total, 0);
                summaryTableBody.innerHTML += `
                <tr>
                    <td>${plate}</td>
                    <td>${firstM.toLocaleString()}</td>
                    <td>${lastM.toLocaleString()}</td>
                    <td>${dist.toLocaleString()}</td>
                    <td>${litreSum.toFixed(2)}</td>
                    <td>${costSum.toFixed(2)}</td>
                </tr>`;
            });
            if (!summaryTableBody.innerHTML) {
                summaryTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">ไม่มีข้อมูลในเดือนที่เลือก</td></tr>`;
            }
        });

        // ===== Logout =====
        const logoutLink = document.getElementById("logoutLink");
        if (logoutLink) {
            logoutLink.addEventListener("click", e => {
                e.preventDefault();
                localStorage.clear();
                window.location.href = "login.html";
            });
        }

        // ===== INIT =====
        function init() {
            document.getElementById("summaryMonth").value = "2025-11";
            carColorPreview.style.background = carColorPicker.value;
            renderDashboard();
            renderCarTable();
            renderUserTable();
            renderBorrowTable();
            renderFuelTable();
            showSection("section-dashboard");
        }
        init();
    </script>
</body>

</html>