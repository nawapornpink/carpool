{% extends 'booking/base.html' %}
{% load static %}

{% block title %}หน้าหลักผู้ใช้งาน - ระบบจองรถ กดส.{% endblock %}

{% block extra_head %}
  {{ block.super }}

  <link rel="stylesheet" href="{% static 'css/pea-theme.css' %}"/>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet"/>

  <style>
    .page-inner{
      margin-top: 2.0rem;
      margin-bottom: 4.5rem;
    }

    .dash-wrap{
      max-width: 1180px;
      margin: 0 auto;
    }

    .section-title{
      font-weight: 900;
      letter-spacing: .2px;
      color: var(--pea-purple);
    }
    .empty-text{
      color: #64748b;
      margin-bottom: 0;
    }

    .calendar-shell{
      background: #ffffff;
      border-radius: 20px;
      padding: 14px;
      height: 100%;
      border: 1px solid rgba(116,4,95,.14);
      box-shadow: 0 14px 36px rgba(116,4,95,.10);
      overflow: hidden;
    }

    .cal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;

      padding: 10px 14px;
      border-radius: 16px;

      background: linear-gradient(135deg, #6f0f55 0%, #5c0b47 55%, #4a0839 100%);
      position: relative;
      overflow: hidden;

      max-width: 980px;
      margin: 0 auto 12px;
    }

    .cal-header:after{
      content:"";
      position:absolute;
      inset:-45%;
      background: radial-gradient(circle at 28% 25%, rgba(199,145,27,.18), transparent 62%);
      pointer-events:none;
    }

    .cal-header:before{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height:2px;
      opacity:.70;
      background: linear-gradient(90deg, rgba(199,145,27,.10), rgba(199,145,27,.92), rgba(199,145,27,.10));
      pointer-events:none;
    }

    .cal-left{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 170px;
      z-index: 1;
    }

    .cal-title{
      font-size: .95rem;
      font-weight: 1000;
      color: #fff;
      letter-spacing: .2px;
      opacity: .95;
    }

    

        .cal-nav{
      display:flex;
      gap: 10px;
      align-items: center;
      z-index: 1;
    }

.cal-nav button{
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: 999px;

      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.98);

      display: grid;
      place-items: center;

      box-shadow:
        0 10px 22px rgba(0,0,0,.14),
        inset 0 1px 0 rgba(255,255,255,.10);

      transition:
        transform .10s ease,
        background .16s ease,
        box-shadow .16s ease,
        border-color .16s ease;

      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);

      position: relative;
      overflow: hidden;
    }

    .cal-nav button i{
      font-size: 1.08rem;
      line-height: 1;
      display:block;
      transform: translateY(.5px);
      opacity: .96;
    }

    .cal-nav button:before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:999px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.14), transparent 55%);
      opacity:0;
      transition: opacity .16s ease;
      pointer-events:none;
    }

    .cal-nav button:hover{
      background: rgba(255,255,255,.12);
      border-color: rgba(199,145,27,.34);
      box-shadow:
        0 14px 30px rgba(0,0,0,.18),
        inset 0 1px 0 rgba(255,255,255,.14),
        0 0 0 3px rgba(199,145,27,.10);
    }
    .cal-nav button:hover:before{ opacity: 1; }

    .cal-nav button:active{
      transform: scale(.97);
      background: rgba(255,255,255,.14);
      box-shadow:
        0 10px 22px rgba(0,0,0,.16),
        inset 0 1px 0 rgba(255,255,255,.12);
    }

.cal-nav button i{
      font-size: 1.05rem;
      line-height: 1;
      display:block;
      transform: translateY(.5px); /* optical centering for chevrons */
    }
    .cal-nav button:hover{
      background: rgba(255,255,255,.16);
      border-color: rgba(199,145,27,.35);
      box-shadow: 0 14px 30px rgba(0,0,0,.18);
    }
    .cal-nav button:active{ transform: scale(.97); }
.cal-nav button:hover{
      background: rgba(255,255,255,.16);
      color: #fff;
    }
    .cal-nav button:active{
      transform: translateX(var(--tx)) scale(.97);
    }

    /* optical centering for glyphs */
    #btnPrev{ --tx: -0.5px; }
    #btnNext{ --tx: 0.5px; }
.cal-month{
      flex: 1;
      text-align: center;
      font-size: 1.75rem;
      font-weight: 1000;
      color: #fff;
      letter-spacing: .30px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      z-index: 1;
    }

    .cal-today{ z-index: 1; }
    .cal-today button{
      height: 34px;
      padding: 0 .95rem;
      border-radius: 999px;

      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.92);
      color: var(--pea-purple);

      font-weight: 1000;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      transition: transform .08s ease, background .12s ease, box-shadow .12s ease;
      white-space: nowrap;
    }
    .cal-today button:hover{
      background: rgba(199,145,27,.92);
      color:#2a1b28;
      box-shadow: 0 14px 30px rgba(0,0,0,.22);
    }
    .cal-today button:active{ transform: scale(.99); }

    .fc-skin{
      max-width: 980px;
      margin: 0 auto;
      background: transparent;
      padding: 0;
    }

    .fc .fc-scrollgrid{
      border: 1px solid rgba(15,23,42,.10) !important;
      border-radius: 16px;
      overflow: hidden;
      background:#fff;
    }
    .fc-theme-standard td,
    .fc-theme-standard th{ border-color: rgba(15,23,42,.08) !important; }

    .fc .fc-col-header-cell{
      background: linear-gradient(180deg, rgba(116,4,95,.06), rgba(116,4,95,.02)) !important;
      padding: 10px 0 !important;
    }
    .fc .fc-col-header-cell-cushion{
      font-weight: 1000;
      color: var(--pea-purple);
      text-decoration: none !important;
      font-size: .95rem;
      letter-spacing: .15px;
    }

    .fc .fc-daygrid-day{ background:#fff; }
    .fc .fc-daygrid-day-frame{
      padding: 8px 10px;
      min-height: 92px;
      background: transparent !important;
      box-shadow:none !important;
      display:block !important;
      border-radius: 10px;
      transition: background .12s ease;
    }
    .fc .fc-daygrid-day:hover{
      background: rgba(116,4,95,.03);
    }

    .fc .fc-daygrid-day-top{ flex-direction: row-reverse; }
    .fc .fc-daygrid-day-number{
      font-weight: 900;
      font-size: .95rem;
      color:#0f172a;
      text-decoration: none !important;
      padding: 0 !important;
      opacity:.92;
    }

    .fc .fc-day-today{
      background: linear-gradient(180deg, rgba(199,145,27,.20), rgba(199,145,27,.06)) !important;
      outline: none !important;
      box-shadow:
        inset 0 0 0 9999px rgba(255,255,255,.35),
        inset 0 0 0 9999px rgba(199,145,27,.05);
    }

    .fc .fc-day-today .fc-daygrid-day-number{
      position: relative;
    }
    .fc .fc-day-today .fc-daygrid-day-number:after{
      content:"";
      position:absolute;
      right:-8px;
      top:2px;
      width:6px;
      height:6px;
      border-radius:999px;
      background: rgba(199,145,27,.95);
      box-shadow: 0 0 0 3px rgba(199,145,27,.18);
    }

    .fc .fc-daygrid-day-events{ max-height: none !important; }
    .fc .fc-daygrid-more-link{ display: none !important; }

    .fc .fc-event{
      border: 0 !important;
      border-radius: 999px !important;
      padding: 4px 10px !important;
      font-size: .78rem !important;
      font-weight: 1000 !important;
      color: #fff !important;
      box-shadow: 0 8px 18px rgba(15,23,42,.12);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      position: relative;
    }
    .fc .fc-event:before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      pointer-events:none;
    }
    .fc .fc-event .fc-event-main{ color: #fff !important; padding: 0 !important; }

    .card.card-soft{
      border-radius: 20px;
      border: 1px solid rgba(116,4,95,.14);
      box-shadow: 0 14px 36px rgba(116,4,95,.10);
      overflow: hidden;
    }

    .table-card{
      background: rgba(248,250,252,.92);
    }

    .table-card .table{
      margin-bottom: 0;
    }

    .table-card .table tbody tr{
      background: rgba(255,255,255,.72);
    }

    .table-card .table tbody td{
      color: rgba(15,23,42,.88);
      border-top: 1px solid rgba(15,23,42,.10) !important;
      padding-top: .9rem;
      padding-bottom: .9rem;
    }

    .table-card .table tbody tr:hover{
      background: rgba(116,4,95,.05) !important;
    }

    .table-card thead th{
      background: linear-gradient(135deg, #6f0f55 0%, #5c0b47 100%) !important;
      color:#fff !important;
      border-bottom: 3px solid rgba(199,145,27,.75) !important;
      font-weight: 1000 !important;
      letter-spacing: .1px;
      padding-top: .85rem;
      padding-bottom: .85rem;
      white-space: nowrap;
    }

    .pea-badge{
      display:inline-block;
      border-radius: 999px;
      padding: .38rem .70rem;
      font-weight: 1000;
      font-size: .82rem;
      line-height: 1;
      white-space: nowrap;
    }

    .pea-badge.status-booked{
      background: rgba(13,110,253,.14) !important;
      color: #0b5ed7 !important;
    }
    .pea-badge.status-inuse{
      background: rgba(255,193,7,.20) !important;
      color: #9a6b00 !important;
    }
    .pea-badge.status-returned{
      background: rgba(25,135,84,.16) !important;
      color: #146c43 !important;
    }
    .pea-badge.status-cancelled{
      background: rgba(220,53,69,.14) !important;
      color: #b02a37 !important;
    }
    .pea-badge.status-unknown{
      background: rgba(108,117,125,.14) !important;
      color: #495057 !important;
    }

    .modal-status{
      border-radius: 999px;
      padding: .38rem .70rem;
      font-weight: 1000;
      font-size: .82rem;
      line-height: 1;
      white-space: nowrap;
      display:inline-block;
    }

    @media (max-width: 1200px){
      .dash-wrap{ max-width: 1040px; }
      .cal-header, .fc-skin{ max-width: 920px; }
    }
    @media (max-width: 992px){
      .dash-wrap{ max-width: 860px; }
      .cal-header, .fc-skin{ max-width: 860px; }
      .cal-left{ min-width: 170px; }
      .cal-month{ font-size: 1.60rem; text-align:left; }
    }
    @media (max-width: 576px){
      .dash-wrap{ max-width: 100%; }
      .cal-header, .fc-skin{ max-width: 100%; }
      .cal-header{ flex-direction: column; align-items: stretch; }
      .cal-month{ text-align: left; }
      .cal-today{ align-self: flex-start; }
      .fc .fc-daygrid-day-frame{ padding: 8px; min-height: 86px; }
    }
  

    /* safety: ensure no old divider line appears */
    .cal-nav button + button:before{ content:none !important; display:none !important; }

    /* =========================
       TABLE POLISH (muted border)
       ========================= */
    .table-card{
      background: rgba(248,250,252,.92);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 12px 30px rgba(15,23,42,.06);
    }

    .table-card .card-body{ padding: 16px 16px 14px; }

    .table-card .table{
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border-radius: 16px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(15,23,42,.10);
    }

    .table-card thead th{
      background: linear-gradient(135deg, #6b0f53 0%, #5b0b47 55%, #4a0839 100%) !important;
      color:#fff !important;
      border-bottom: 3px solid rgba(199,145,27,.70) !important;
      font-weight: 1000 !important;
      letter-spacing: .12px;
      padding: .9rem .9rem;
    }

    .table-card thead th:first-child{ border-top-left-radius: 14px; }
    .table-card thead th:last-child{ border-top-right-radius: 14px; }

    .table-card tbody tr{
      background: transparent !important;
    }

    .table-card tbody td{
      border-top: 0 !important;
      border-bottom: 1px solid rgba(15,23,42,.10) !important;
      padding: 1rem .9rem;
      color: rgba(15,23,42,.88);
      vertical-align: middle;
    }

    .table-card tbody tr:last-child td{
      border-bottom: 0 !important;
    }

    .table-card tbody tr:hover td{
      background: rgba(116,4,95,.045) !important;
    }

    .table-card .table-responsive{
      border-radius: 16px;
    }

    /* make last column not stick to edge */
    .table-card td.text-end, .table-card th.text-end{
      padding-right: 1.05rem !important;
    }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid page-inner px-2 px-xl-3">
  <div class="dash-wrap">
<div class="row g-4 align-items-stretch mb-4">

      <div class="col-xl-9 col-lg-8">
        <div class="calendar-shell h-100">

          <div class="cal-header">
            <div class="cal-left">
              <div class="cal-title">ปฏิทินการจองรถ</div>
              <div class="cal-nav">
                <button type="button" id="btnPrev" aria-label="previous month"><i class="bi bi-chevron-left"></i></button>
                <button type="button" id="btnNext" aria-label="next month"><i class="bi bi-chevron-right"></i></button>
              </div>
            </div>

            <div class="cal-month" id="calMonthTitle">-</div>

            <div class="cal-today">
              <button type="button" id="btnToday">today</button>
            </div>
          </div>

          <div class="fc-skin">
            <div id="calendar"></div>
          </div>

        </div>
      </div>

      <div class="col-xl-3 col-lg-4">
        <div class="card card-soft h-100 d-flex flex-column">
          <div class="card-body d-flex flex-column">

            <div class="mb-2 d-flex justify-content-between align-items-center">
              <span class="section-title mb-0">รถที่พร้อมให้จอง</span>
            </div>

            {% if available_cars %}
              <div class="list-group list-group-flush small mb-3">
                {% for car in available_cars %}
                  <div class="list-group-item border-0 px-0 py-2 d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold d-flex align-items-baseline gap-2">
                        <span>{{ car.plate_prefix }} {{ car.plate_number }}</span>
                        <span class="text-muted small">{{ car.province_full }}</span>
                      </div>
                      <div class="text-muted">{{ car.brand_name }} {{ car.model_name }}</div>
                    </div>
                    <span class="pea-badge status-returned">พร้อมใช้งาน</span>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="empty-text mb-3">ขณะนี้ไม่มีรถที่พร้อมให้จอง</p>
            {% endif %}

            <hr class="mt-0 mb-2" />

            <div class="mb-2">
              <div class="small mb-1 text-muted">เลือกดูปฏิทินของรถคันนี้</div>
              <select id="carFilter" class="form-select form-select-sm">
                <option value="all">แสดงรถทุกคันในปฏิทิน</option>
                {% for car in all_cars %}
                  <option value="{{ car.id }}">
                    {{ car.plate_prefix }} {{ car.plate_number }} {{ car.province_full }} -
                    {{ car.brand_name }} {{ car.model_name }}
                  </option>
                {% endfor %}
              </select>
            </div>

          </div>
        </div>
      </div>

    </div>

    <div class="row">
      <div class="col-12">
        <div class="card card-soft table-card">
          <div class="card-body">

            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="section-title mb-0">รายการจองของคุณ</span>
            </div>

            {% if my_bookings %}
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>วันที่ใช้รถ</th>
                      <th>รถที่ใช้</th>
                      <th>ปลายทาง</th>
                      <th>ผู้สร้างคำขอ</th>
                      <th class="text-center">สถานะ</th>
                      <th class="text-end">จัดการ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for booking in my_bookings %}
                      <tr>
                        <td>
                          {{ booking.start_date|date:"d/m/Y" }}
                          {% if booking.end_date %}- {{ booking.end_date|date:"d/m/Y" }}{% endif %}
                        </td>

                        <td>
                          {% if booking.car %}
                            <div class="fw-semibold">
                              {{ booking.car.plate_prefix }}{{ booking.car.plate_number }} {{ booking.car.province_full }}
                            </div>
                            <div class="text-muted small">{{ booking.car.brand_name }} {{ booking.car.model_name }}</div>
                          {% else %}
                            -
                          {% endif %}
                        </td>

                        <td>{{ booking.destination|default:"-" }}</td>

                        <td>
                          {% if booking.requester %}
                            {% with booking.requester as r %}
                              {{ r.profile.full_name|default:r.get_full_name|default:r.username }}
                            {% endwith %}
                          {% else %}
                            -
                          {% endif %}
                        </td>

                        <td class="text-center">
                          {% with raw=booking.status disp=booking.get_status_display %}
                            <span class="pea-badge
                              {% if raw == 'BOOKED' %}status-booked
                              {% elif raw == 'IN_USE' %}status-inuse
                              {% elif raw == 'RETURNED' %}status-returned
                              {% elif raw == 'CANCELLED' %}status-cancelled
                              {% else %}status-unknown{% endif %}">
                              {% if disp %}{{ disp }}{% elif raw %}{{ raw }}{% else %}-{% endif %}
                            </span>
                          {% endwith %}
                        </td>

                        <td class="text-end">
                          {% if booking.can_cancel or booking.status == 'BOOKED' %}
                            <form method="post" action="{% url 'booking:cancel_booking' booking.id %}" class="d-inline">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-sm btn-outline-danger"
                                      onclick="return confirm('ยืนยันการยกเลิกการจองรายการนี้?');">
                                ยกเลิก
                              </button>
                            </form>
                          {% else %}
                            <span class="text-muted small">-</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="empty-text mb-0">ยังไม่มีรายการจองของคุณ</p>
            {% endif %}

          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="modal fade" id="bookingDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="border-radius:18px; overflow:hidden;">
      <div class="modal-header" style="background:linear-gradient(135deg,#6f0f55 0%,#5c0b47 100%); color:#fff; border-bottom:3px solid rgba(199,145,27,.75);">
        <h5 class="modal-title">รายละเอียดการจองรถ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter:invert(1)"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="small text-muted mb-1">รถที่ใช้</div>
            <div id="modalBookingCar" class="fw-semibold"></div>
            <div id="modalBookingCarModel" class="text-muted small"></div>
          </div>
          <div class="col-md-6">
            <div class="small text-muted mb-1">สถานะ</div>
            <span id="modalBookingStatus" class="modal-status status-unknown">-</span>
          </div>

          <div class="col-md-6">
            <div class="small text-muted mb-1">ช่วงวันที่ใช้รถ</div>
            <div id="modalBookingDates"></div>
          </div>
          <div class="col-md-6">
            <div class="small text-muted mb-1">ผู้สร้างคำขอ</div>
            <div id="modalBookingRequester"></div>
          </div>

          <div class="col-12">
            <div class="small text-muted mb-1">ผู้เดินทาง</div>
            <div id="modalBookingCoTravelers"></div>
          </div>

          <div class="col-12">
            <div class="small text-muted mb-1">ปลายทาง / วัตถุประสงค์</div>
            <div id="modalBookingPurpose"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ปิด</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const calendarEl = document.getElementById("calendar");
      const carFilterEl = document.getElementById("carFilter");

      const rawEvents = [
        {% for b in all_bookings %}
          {% if b.car %}
            {
              id: "{{ b.id }}",
              title: "{{ b.car.plate_prefix }}{{ b.car.plate_number }} {{ b.car.province_full }}",
              start: "{{ b.start_date|date:'Y-m-d' }}",
              allDay: true,
              backgroundColor: "{{ b.car.color_code|default:'#74045F' }}",
              borderColor: "{{ b.car.color_code|default:'#74045F' }}",
              textColor: "#ffffff",
              extendedProps: {
                carId: "{{ b.car.id }}",
                plate: "{{ b.car.plate_prefix }}{{ b.car.plate_number }}",
                province: "{{ b.car.province_full }}",
                brand: "{{ b.car.brand_name }}",
                model: "{{ b.car.model_name }}",
                requester: "{% if b.requester %}{{ b.requester.profile.full_name|default:b.requester.get_full_name|default:b.requester.username|escapejs }}{% endif %}",
                coTravelers: "{% for ct in b.co_travelers.all %}{% if ct.user %}{{ ct.user.profile.full_name|default:ct.user.get_full_name|default:ct.user.username|escapejs }}{% if not forloop.last %}, {% endif %}{% endif %}{% endfor %}",
                destination: "{{ b.destination|default_if_none:''|escapejs }}",
                statusText: "{{ b.get_status_display|default:b.status|escapejs }}",
                rawStatus: "{{ b.status|default:''|escapejs }}",
                startText: "{{ b.start_date|date:'d/m/Y' }}",
                {% if b.end_date %}
                endText: "{{ b.end_date|date:'d/m/Y' }}",
                endRaw: "{{ b.end_date|date:'Y-m-d' }}",
                {% else %}
                endText: "",
                endRaw: null,
                {% endif %}
              }
            }{% if not forloop.last %},{% endif %}
          {% endif %}
        {% endfor %}
      ];

      function expandToDailyEvents(events) {
        const result = [];
        events.forEach((ev) => {
          const startDate = new Date(ev.start + "T00:00:00");
          const endRaw = ev.extendedProps && ev.extendedProps.endRaw;

          if (!endRaw) { result.push(ev); return; }

          const endDate = new Date(endRaw + "T00:00:00");
          let current = new Date(startDate);

          while (current <= endDate) {
            const y = current.getFullYear();
            const m = String(current.getMonth() + 1).padStart(2, "0");
            const d = String(current.getDate()).padStart(2, "0");
            const dayStr = `${y}-${m}-${d}`;
            result.push({ ...ev, start: dayStr, end: undefined });
            current.setDate(current.getDate() + 1);
          }
        });
        return result;
      }

      const allEvents = expandToDailyEvents(rawEvents);

      const bookingModalEl = document.getElementById("bookingDetailModal");
      let bookingModal = null;
      if (bookingModalEl && window.bootstrap) {
        bookingModal = new bootstrap.Modal(bookingModalEl);
      }

      function statusClass(raw){
        if(raw === "BOOKED") return "status-booked";
        if(raw === "IN_USE") return "status-inuse";
        if(raw === "RETURNED") return "status-returned";
        if(raw === "CANCELLED") return "status-cancelled";
        return "status-unknown";
      }

      const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: "th",
        firstDay: 1,
        headerToolbar: false,

        height: "auto",
        contentHeight: "auto",

        fixedWeekCount: false,
        showNonCurrentDates: false,

        expandRows: true,
        dayMaxEventRows: false,
        dayMaxEvents: false,

        eventDisplay: "block",
        events: allEvents,

        datesSet: function() {
          const titleEl = document.getElementById("calMonthTitle");
          if (titleEl) titleEl.textContent = calendar.view.title;
        },

        eventClick: function (info) {
          const p = info.event.extendedProps || {};

          const carText = `${p.plate || ""} ${p.province || ""}`.trim();
          document.getElementById("modalBookingCar").textContent = carText || "-";
          document.getElementById("modalBookingCarModel").textContent =
            `${p.brand || ""} ${p.model || ""}`.trim() || "-";

          let dateText = p.startText || "";
          if (p.endText) dateText += ` - ${p.endText}`;
          document.getElementById("modalBookingDates").textContent = dateText || "-";

          document.getElementById("modalBookingRequester").textContent = p.requester || "-";

          const co = p.coTravelers && p.coTravelers.trim() ? p.coTravelers : "-";
          document.getElementById("modalBookingCoTravelers").textContent = co;

          document.getElementById("modalBookingPurpose").textContent = p.destination || "-";

          const statusEl = document.getElementById("modalBookingStatus");
          const raw = (p.rawStatus || "").trim();
          statusEl.textContent = p.statusText || raw || "-";
          statusEl.className = `modal-status ${statusClass(raw)}`;

          if (bookingModal) bookingModal.show();
        }
      });

      calendar.render();

      const btnPrev = document.getElementById("btnPrev");
      const btnNext = document.getElementById("btnNext");
      const btnToday = document.getElementById("btnToday");

      if (btnPrev) btnPrev.addEventListener("click", () => calendar.prev());
      if (btnNext) btnNext.addEventListener("click", () => calendar.next());
      if (btnToday) btnToday.addEventListener("click", () => calendar.today());

      function applyCarFilter() {
        const carId = carFilterEl.value;
        calendar.removeAllEvents();

        if (carId === "all") {
          allEvents.forEach((ev) => calendar.addEvent(ev));
        } else {
          allEvents
            .filter((ev) => String(ev.extendedProps.carId) === String(carId))
            .forEach((ev) => calendar.addEvent(ev));
        }
      }

      if (carFilterEl) carFilterEl.addEventListener("change", applyCarFilter);
    });
  </script>
{% endblock %}
