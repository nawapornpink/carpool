{% extends "booking/base.html" %}
{% load humanize %}

{% block title %}เริ่มใช้งาน / คืนรถ{% endblock %}

{% block extra_head %}
<style>
  .card-soft{
    border-radius:18px;
    border:1px solid rgba(0,0,0,.06);
    background:#fff;
  }
  .badge-pill{
    border-radius:999px;
    padding:.42rem .75rem;
    font-weight:800;
    font-size:.85rem;
  }
  .text-sub{
    font-size:.92rem;
    color:#64748b;
  }
  .btn-pill{
    border-radius:999px;
    padding:.48rem 1.05rem;
    font-weight:800;
  }
  .box{
    border:1px solid rgba(0,0,0,.06);
    background:#f8fafc;
    border-radius:16px;
  }
  .mini-title{
    font-weight:900;
    letter-spacing:.2px;
  }
  .kv{
    display:flex;
    justify-content:space-between;
    gap:1rem;
    margin-top:.35rem;
  }
  .kv .k{ color:#64748b; font-size:.92rem; }
  .kv .v{ font-weight:700; }
  .table thead th{ white-space:nowrap; }
</style>
{% endblock %}

{% block content %}
<div class="container py-3">

  <div class="mb-3">
    <h3 class="fw-bold mb-1">เริ่มใช้งาน / คืนรถ</h3>
    <div class="text-sub">
      เลือกรายการของคุณ แล้วทำ “เริ่มใช้งาน (เลขไมล์ก่อน)” หรือ “คืนรถ (เลขไมล์หลัง)”
    </div>
  </div>

  <div class="row g-3">

    <!-- LEFT -->
    <div class="col-lg-5">
      <div class="card card-soft shadow-sm">
        <div class="card-body">

          <div class="mini-title mb-2">1) เลือกรายการของคุณ</div>

          <form method="get">
            <select name="booking_id" class="form-select" onchange="this.form.submit()">
              <option value="">-- เลือกรายการ --</option>
              {% for b in available_bookings %}
                <option value="{{ b.id }}" {% if selected_booking_id and selected_booking_id == b.id %}selected{% elif booking and booking.id == b.id %}selected{% endif %}>
                  {{ b.car.plate_prefix }} {{ b.car.plate_number }} {{ b.car.province_full }}
                  | {{ b.car.brand_name }} {{ b.car.model_name }}
                </option>
              {% endfor %}
            </select>

            <div class="form-text">
              ถ้าไม่เห็นรายการ: อาจยังไม่มีการจอง หรือคุณไม่อยู่ในรายการผู้สร้างคำขอ/ผู้เดินทาง
            </div>
          </form>

          {% if booking %}
            <div class="box p-3 mt-3">
              <div class="fw-bold mb-2">สรุปรายการที่เลือก</div>

              <div class="d-flex justify-content-between">
                <div class="k">รถ</div>
                <div class="v">
                  {{ booking.car.plate_prefix }} {{ booking.car.plate_number }} ({{ booking.car.province_full }})
                </div>
              </div>

              <div class="d-flex justify-content-between mt-2">
                <div class="k">ช่วงวัน</div>
                <div class="v">
                  {{ booking.start_date|date:"d/m/Y" }} – {{ booking.end_date|date:"d/m/Y" }}
                </div>
              </div>

              <div class="d-flex justify-content-between mt-2">
                <div class="k">สถานะ</div>
                <div>
                  {% if booking.status == "BOOKED" %}
                    <span class="badge bg-primary badge-pill">จองแล้ว</span>
                  {% elif booking.status == "IN_USE" %}
                    <span class="badge bg-info text-dark badge-pill">กำลังใช้งาน</span>
                  {% elif booking.status == "RETURNED" %}
                    <span class="badge bg-success badge-pill">คืนรถแล้ว</span>
                  {% elif booking.status == "PENDING_RETURN" %}
                    <span class="badge bg-warning text-dark badge-pill">รอคืนรถ</span>
                  {% elif booking.status == "CANCELLED" %}
                    <span class="badge bg-secondary badge-pill">ยกเลิก</span>
                  {% else %}
                    <span class="badge bg-secondary badge-pill">{{ booking.status }}</span>
                  {% endif %}
                </div>
              </div>

              <div class="d-flex justify-content-between mt-2">
                <div class="k">เลขไมล์ก่อน</div>
                <div class="v">
                  {% if booking.odometer_before %}{{ booking.odometer_before|intcomma }}{% else %}-{% endif %}
                </div>
              </div>

              <div class="d-flex justify-content-between mt-2">
                <div class="k">เลขไมล์หลัง</div>
                <div class="v">
                  {% if booking.odometer_after %}{{ booking.odometer_after|intcomma }}{% else %}-{% endif %}
                </div>
              </div>

            </div>
          {% endif %}

        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="col-lg-7">

      {% if not booking %}
        <div class="card card-soft shadow-sm">
          <div class="card-body">
            <div class="text-muted">
              เลือกรายการทางซ้ายก่อน แล้วฟอร์มเริ่มใช้งาน/คืนรถจะขึ้นตรงนี้
            </div>
          </div>
        </div>
      {% else %}

        <!-- (2) เริ่มใช้งาน -->
        {% if booking.status == "BOOKED" %}
          <div class="card card-soft shadow-sm mb-3">
            <div class="card-body">
              <div class="fw-bold mb-2">2) เริ่มใช้งาน (เลขไมล์ก่อน)</div>

              <form
                method="post"
                action="{% url 'booking:user_return_car' %}?booking_id={{ booking.id }}"
                class="row g-3"
              >
                {% csrf_token %}
                <input type="hidden" name="action" value="start_use">
                <input type="hidden" name="booking_id" value="{{ booking.id }}">

                <div class="col-md-6">
                  <label class="form-label fw-bold">เลขไมล์ก่อน</label>
                  <input type="number" name="odometer_before" class="form-control" required>
                </div>
                <div class="col-12 d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary btn-pill">เริ่มใช้งาน</button>
                </div>
              </form>
            </div>
          </div>
        {% endif %}

        <!-- (3) คืนรถ (IN_USE) -->
        {% if booking.status == "IN_USE" %}
          <div class="card card-soft shadow-sm mb-3">
            <div class="card-body">
              <div class="fw-bold mb-2">3) คืนรถ (เลขไมล์หลัง)</div>

              <form
                method="post"
                action="{% url 'booking:user_return_car' %}?booking_id={{ booking.id }}"
                class="row g-3"
              >
                {% csrf_token %}
                <input type="hidden" name="action" value="return">
                <input type="hidden" name="booking_id" value="{{ booking.id }}">

                <div class="col-md-6">
                  <label class="form-label fw-bold">เลขไมล์หลัง</label>
                  <input type="number" name="odometer_after" class="form-control" required>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-bold">มีการเติมน้ำมันหรือไม่</label>
                  <select name="has_fuel" class="form-select" required>
                    <option value="" selected>-- เลือก --</option>
                    <option value="NO">ไม่มีเติมน้ำมัน</option>
                    <option value="YES">มีเติมน้ำมัน</option>
                  </select>
                </div>

                <div class="col-12 d-flex justify-content-end gap-2 flex-wrap">
                  <button type="submit" class="btn btn-primary btn-pill">
                    ยืนยันคืนรถ
                  </button>
                </div>

                <div class="text-sub">
                  ถ้าเลือก “มีเติมน้ำมัน” ระบบจะพาไปหน้าบันทึกการเติมน้ำมันทันที
                </div>
              </form>
            </div>
          </div>
        {% endif %}

        <!-- ✅ (3) ปิดรายการคืนรถ (PENDING_RETURN) : เหลือการ์ดเดียว ไม่ซ้ำ -->
        {% if booking.status == "PENDING_RETURN" %}
          <div class="card card-soft shadow-sm mb-3">
            <div class="card-body">
              <div class="fw-bold mb-1">3) ปิดรายการคืนรถ</div>
              <div class="text-sub mb-3">
                รายการนี้อยู่ระหว่างรอการยืนยันคืนรถ
                คุณสามารถบันทึกการเติมน้ำมันเพิ่ม แล้วกดยืนยันคืนรถได้ที่นี่
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  <div class="fw-bold mb-1">เลขไมล์หลัง</div>
                  <div class="form-control bg-light">
                    {% if booking.odometer_after %}{{ booking.odometer_after|intcomma }}{% else %}-{% endif %}
                  </div>
                  <div class="text-sub mt-1">เลขไมล์หลังถูกบันทึกแล้ว (แก้ไขให้กลับไปทำตอน “คืนรถ”)</div>
                </div>

                <div class="col-md-6 d-flex align-items-end justify-content-end gap-2 flex-wrap">
                  <a
                    href="{% url 'booking:user_fuel_refill' %}?booking_id={{ booking.id }}"
                    class="btn btn-outline-primary btn-pill"
                  >
                    ไปบันทึกการเติมน้ำมัน
                  </a>

                  <form
                    method="post"
                    action="{% url 'booking:user_confirm_return' booking.id %}"
                    class="m-0"
                  >
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-pill">
                      ยืนยันคืนรถ
                    </button>
                  </form>
                </div>
              </div>

              <!-- ตารางเติมน้ำมัน -->
              <div class="mt-4">
                <div class="fw-bold mb-2">รายการเติมน้ำมันของทริปนี้</div>

                {% if booking.fuel_refills.all %}
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th class="text-nowrap">วันที่</th>
                          <th>สถานที่</th>
                          <th class="text-end text-nowrap">ลิตร</th>
                          <th class="text-end text-nowrap">บาท/ลิตร</th>
                          <th class="text-end text-nowrap">รวม (บาท)</th>
                          <th class="text-end text-nowrap">เลขไมล์</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for f in booking.fuel_refills.all %}
                          <tr>
                            <td class="text-nowrap">
                              {% if f.refill_date %}{{ f.refill_date|date:"d/m/Y" }}
                              {% elif f.date %}{{ f.date|date:"d/m/Y" }}
                              {% else %}-{% endif %}
                            </td>
                            <td>{{ f.fuel_place|default_if_none:"-" }}</td>
                            <td class="text-end">{{ f.liters|default_if_none:"-" }}</td>
                            <td class="text-end">{{ f.price_per_liter|default_if_none:"-" }}</td>
                            <td class="text-end fw-semibold">{{ f.total_price|default_if_none:"-" }}</td>
                            <td class="text-end">{{ f.odometer|default_if_none:"-" }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <div class="text-muted">ยังไม่มีรายการเติมน้ำมัน</div>
                {% endif %}
              </div>

              <div class="text-sub mt-3">
                หมายเหตุ: ปุ่ม “ยืนยันคืนรถ” จะสำเร็จเมื่อมีรายการเติมน้ำมันอย่างน้อย 1 รายการ (ตามเงื่อนไขระบบ)
              </div>
            </div>
          </div>
        {% endif %}

      {% endif %}
    </div>

  </div>
</div>
{% endblock %}
