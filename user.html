<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>Carpool – ผู้ใช้งาน</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f5f5f7;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .app-shell {
            max-width: 1100px;
            margin: 24px auto 40px;
        }

        .card-ios {
            border-radius: 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border: none;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px 4px;
        }

        .calendar-title {
            font-weight: 600;
            font-size: 1.4rem;
        }

        .calendar-nav-btn {
            border: none;
            background: transparent;
            font-size: 1.4rem;
            line-height: 1;
            padding: 4px 8px;
            cursor: pointer;
        }

        .calendar-weekdays,
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-weekdays {
            padding: 0 8px 4px;
            text-align: center;
            font-size: .8rem;
            color: #8e8e93;
        }

        .calendar-weekday {
            padding: 4px 0;
        }

        .calendar-grid {
            padding: 4px 8px 12px;
        }

        .calendar-cell {
            min-height: 78px;
            border-radius: 16px;
            padding: 4px 4px 6px;
            margin: 2px;
            position: relative;
            cursor: pointer;
            transition: background-color .15s ease;
        }

        .calendar-cell:hover {
            background-color: #f2f2f7;
        }

        .calendar-day-number {
            font-size: .9rem;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .calendar-cell.muted .calendar-day-number {
            color: #c7c7cc;
        }

        .calendar-cell.today {
            border: 1px solid #0a84ff;
        }

        .badge-booking {
            display: block;
            border-radius: 999px;
            padding: 2px 6px;
            font-size: .68rem;
            color: #fff;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .badge-booking span {
            font-weight: 500;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 12px;
        }

        .form-section {
            border-radius: 24px;
            background: #fff;
            padding: 20px 20px 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
            margin-top: 8px;
        }

        .status-pill {
            padding: 2px 10px;
            border-radius: 999px;
            font-size: .75rem;
            color: #fff;
        }

        .status-using {
            background: #ff9f0a;
        }

        .status-done {
            background: #34c759;
        }

        .btn-pill {
            border-radius: 999px;
        }

        @media(max-width:768px) {
            .calendar-cell {
                min-height: 64px;
            }
        }
    </style>
</head>

<body>
    <div class="app-shell">

        <!-- NAV -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3 rounded-3">
            <div class="container-fluid">
                <a class="navbar-brand fw-semibold" href="#">Carpool</a>
                <div class="navbar-nav">
                    <a class="nav-link active" href="#" data-section-target="section-calendar">ปฏิทินการจอง</a>
                    <a class="nav-link" href="#" data-section-target="section-booking">จองรถ</a>
                    <a class="nav-link" href="#" data-section-target="section-return">ส่งคืนรถ</a>
                    <a class="nav-link" href="#" data-section-target="section-fuel">เติมน้ำมัน</a>
                    <a class="nav-link" href="#" data-section-target="section-history">รายการยืมทั้งหมด</a>
                    <a class="nav-link ms-lg-3" href="#" id="logoutLink">ออกจากระบบ</a>
                </div>
            </div>
        </nav>

        <!-- ========== SECTION: ปฏิทินการจอง ========== -->
        <section id="section-calendar" class="app-section">
            <h3 class="section-title">ปฏิทินการจองรถ</h3>

            <div class="card card-ios mb-3">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" id="prevMonthBtn">‹</button>
                    <div>
                        <div class="calendar-title" id="calendarTitle"></div>
                        <div class="small text-muted" id="calendarCarLabel">รถทุกคัน</div>
                    </div>
                    <button class="calendar-nav-btn" id="nextMonthBtn">›</button>
                </div>

                <div class="px-3 pb-1">
                    <label class="small text-muted mb-1">แสดงปฏิทินตามทะเบียนรถ</label>
                    <select id="carFilter" class="form-select form-select-sm" style="max-width:260px;">
                        <option value="all">รถทุกคัน</option>
                    </select>
                </div>

                <div class="calendar-weekdays">
                    <div class="calendar-weekday">จ.</div>
                    <div class="calendar-weekday">อ.</div>
                    <div class="calendar-weekday">พ.</div>
                    <div class="calendar-weekday">พฤ.</div>
                    <div class="calendar-weekday">ศ.</div>
                    <div class="calendar-weekday">ส.</div>
                    <div class="calendar-weekday">อา.</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <!-- กล่องรายละเอียดการจองเมื่อคลิกในปฏิทิน -->
            <div class="card card-ios" id="bookingDetailCard" style="display:none;">
                <div class="card-body">
                    <h6 class="mb-2">รายละเอียดการจอง</h6>
                    <div id="bookingDetailContent" class="small"></div>
                </div>
            </div>
            <small class="text-muted d-block mt-2">
                * คลิกที่สีของทะเบียนรถในปฏิทินเพื่อดูรายละเอียดการจองคันนั้น
            </small>
        </section>

        <!-- ========== SECTION: ฟอร์มจองรถ ========== -->
        <section id="section-booking" class="app-section d-none">
            <h3 class="section-title">ฟอร์มจองรถ</h3>

            <div class="form-section">
                <form id="bookingForm" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">รถที่ต้องการใช้</label>
                        <select id="carSelect" class="form-select" required></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">วันที่เริ่มใช้</label>
                        <input type="date" id="startDate" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">วันที่สิ้นสุด</label>
                        <input type="date" id="endDate" class="form-control" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">ผู้ยืมหลัก</label>
                        <select id="mainUser" class="form-select" required></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">จำนวนผู้ร่วมเดินทาง</label>
                        <input type="number" id="passengerCount" class="form-control" min="1" value="1">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">เลขไมล์ก่อนใช้งาน</label>
                        <input type="number" id="startMileage" class="form-control" min="0">
                    </div>

                    <div class="col-12" id="passengerContainer"></div>

                    <div class="col-12">
                        <label class="form-label">สถานที่ไปราชการ</label>
                        <input type="text" id="destination" class="form-control"
                            placeholder="เช่น การไฟฟ้าส่วนภูมิภาค เขต 1 (อุดรธานี)">
                    </div>

                    <div class="col-12 d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            เมื่อบันทึก ระบบจะสร้างเลข <strong>ยพ.</strong> ประจำรถคันนั้นอัตโนมัติ
                        </small>
                        <button class="btn btn-primary btn-pill" type="submit">เพิ่มการจองตัวอย่าง</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- ========== SECTION: ส่งคืนรถ ========== -->
        <section id="section-return" class="app-section d-none">
            <h3 class="section-title">ส่งคืนรถ</h3>
            <div class="card card-ios">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">เลือกรถที่ต้องการส่งคืน</label>
                        <select id="returnSelect" class="form-select"></select>
                    </div>
                    <div id="returnInfo" class="border rounded-3 p-3 mb-3 bg-light" style="display:none;"></div>
                    <div id="returnForm" style="display:none;">
                        <div class="mb-3">
                            <label class="form-label">เลขไมล์หลังใช้งาน</label>
                            <input type="number" id="endMileage" class="form-control">
                        </div>
                        <button class="btn btn-success btn-pill" id="returnSubmitBtn">ยืนยันการส่งคืน</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== SECTION: เติมน้ำมัน ========== -->
        <section id="section-fuel" class="app-section d-none">
            <h3 class="section-title">บันทึกการเติมน้ำมัน</h3>
            <div class="card card-ios mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">ทะเบียนรถ</label>
                            <select id="fuelCar" class="form-select"></select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">เลขไมล์ก่อนเติม</label>
                            <input type="number" id="fuelMileage" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ราคาน้ำมันต่อลิตร</label>
                            <input type="number" id="fuelPrice" class="form-control" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">จำนวนลิตร</label>
                            <input type="number" id="fuelLitre" class="form-control" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ราคารวม (บาท)</label>
                            <input type="number" id="fuelTotal" class="form-control" step="0.01">
                            <div class="form-text">
                                กรอกราคารวมน้ำมันที่จ่ายจริง ระบบจะคำนวณจำนวนลิตรให้เอง
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                ระบบจะผูกข้อมูลกับเลข <strong>ยพ.</strong> รอบการยืมล่าสุดของรถคันนั้น
                            </small>
                            <button class="btn btn-primary btn-pill" id="fuelSubmitBtn">บันทึกการเติมน้ำมัน</button>
                        </div>
                    </div>
                </div>

                <h6 class="section-title">ตัวอย่างรายการเติมน้ำมัน</h6>
                <div class="card card-ios">
                    <div class="card-body table-responsive">
                        <table class="table table-sm" id="fuelTable">
                            <thead>
                                <tr>
                                    <th>วันที่</th>
                                    <th>ทะเบียนรถ</th>
                                    <th>เลข ยพ.</th>
                                    <th>เลขไมล์</th>
                                    <th>ราคาต่อลิตร</th>
                                    <th>จำนวนลิตร</th>
                                    <th>ราคารวม</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
        </section>

        <!-- ========== SECTION: รายการยืมทั้งหมด ========== -->
        <section id="section-history" class="app-section d-none">
            <h3 class="section-title">รายการยืมรถทั้งหมด</h3>
            <div class="card card-ios">
                <div class="card-body table-responsive">
                    <table class="table table-sm align-middle" id="historyTable">
                        <thead>
                            <tr>
                                <th>เลข ยพ.</th>
                                <th>ทะเบียนรถ</th>
                                <th>ผู้ยืม</th>
                                <th>วันที่ไป</th>
                                <th>วันที่กลับ</th>
                                <th>สถานที่</th>
                                <th>เลขไมล์ออก</th>
                                <th>สถานะ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

    </div>

    <script>
        // ===== ตรวจสอบ Login + Role =====
        const sessionRole = localStorage.getItem("role");
        const sessionEmpName = localStorage.getItem("empName") || "ผู้ใช้งาน";
        const sessionEmpCode = localStorage.getItem("empCode") || "";

        if (!sessionRole) {
            window.location.href = "login.html";
        } else if (sessionRole === "admin") {
            window.location.href = "carpool_admin.html";
        }

        // ===== DATA MOCK =====
        const cars = [
            { plate: "งค-3814 ขก", brand: "ISUZU", model: "D-MAX", color: "#4a90e2" },
            { plate: "งค-3806 ขก", brand: "ISUZU", model: "D-MAX", color: "#2ecc71" },
            { plate: "3ขพ-6247 กทม", brand: "Toyota", model: "REVO", color: "#e67e22" },
            { plate: "3ขพ-6250 กทม", brand: "Toyota", model: "REVO", color: "#9b59b6" },
            { plate: "ขว-6808 ขก", brand: "ISUZU", model: "DOUBLE CAB", color: "#f1c40f" },
            { plate: "ขว-6800 ขก", brand: "ISUZU", model: "DOUBLE CAB", color: "#1abc9c" },
            { plate: "1ขญ-206 กทม", brand: "ISUZU", model: "MU-X", color: "#e84393" },
            { plate: "ขว-6809 ขก", brand: "ISUZU", model: "DOUBLE CAB", color: "#d35400" }
        ];


        const users = [
            { code: "EMP001", name: "นางสาว สุทธาสินี แก้วมณี" },
            { code: "EMP002", name: "นาย ภคิน พันธ์ดี" },
            { code: "EMP003", name: "นางสาว ชญานิษฐ์ นาคำ" },
            { code: "EMP004", name: "นาย ธราเทพ ศูนย์รถ" },
            { code: "EMP005", name: "นางสาว ณัฐกานต์ ศรีบุญเรือง" },
            { code: "EMP006", name: "นาย พิสิษฐ์ กองงาน" },
            { code: "EMP007", name: "นางสาว ชลธิชา พรหมมา" },
            { code: "EMP008", name: "นาย กิตติธัช วัฒนชัย" },
            { code: "EMP009", name: "นางสาว วราภรณ์ จันทร์ดี" },
            { code: "EMP010", name: "นาย นวพล อินทรา" }
        ];

        let bookings = [
            // 1) ใช้งานจบแล้ว ไป-กลับวันเดียว
            {
                id: 1,
                carPlate: "งค-3814 ขก",
                ypNo: "ยพ.3814-001",
                mainUser: "นาย กิตติธัช วัฒนชัย",
                startDate: "2025-12-02",
                endDate: "2025-12-02",
                destination: "ออกตรวจงานสถานีไฟฟ้าย่อย กฟฉ.1",
                startMileage: 82950,
                endMileage: 83060,
                status: "done"
            },

            // 2) ใช้งานจบแล้ว หลายวัน ต่างอำเภอ
            {
                id: 2,
                carPlate: "งค-3806 ขก",
                ypNo: "ยพ.3806-001",
                mainUser: "นางสาว ชญานิษฐ์ นาคำ",
                startDate: "2025-12-05",
                endDate: "2025-12-06",
                destination: "ประชุมโครงการดิจิทัล กฟฟ.เมืองอุดรธานี",
                startMileage: 47014,
                endMileage: 47210,
                status: "done"
            },

            // 3) ใช้งานจบแล้ว ใช้ REVO ทริปยาวหน่อย
            {
                id: 3,
                carPlate: "3ขพ-6247 กทม",
                ypNo: "ยพ.6247-001",
                mainUser: "นางสาว สุทธาสินี แก้วมณี",
                startDate: "2025-12-08",
                endDate: "2025-12-09",
                destination: "ลงพื้นที่สำรวจระบบสื่อสารเชื่อมโยงสถานีไฟฟ้า",
                startMileage: 48120,
                endMileage: 48410,
                status: "done"
            },

            // 4) ยังใช้งานอยู่ (using) – REVO อีกคัน
            {
                id: 4,
                carPlate: "3ขพ-6250 กทม",
                ypNo: "ยพ.6250-001",
                mainUser: "นาย ภคิน พันธ์ดี",
                startDate: "2025-12-15",
                endDate: "2025-12-15",
                destination: "ติดตามงานติดตั้งระบบเครือข่ายสำนักงานย่อย",
                startMileage: 128237,
                status: "using"
            },

            // 5) ยังใช้งานอยู่ (using) – DOUBLE CAB ขว-6808
            {
                id: 5,
                carPlate: "ขว-6808 ขก",
                ypNo: "ยพ.6808-001",
                mainUser: "นางสาว ชลธิชา พรหมมา",
                startDate: "2025-12-18",
                endDate: "2025-12-19",
                destination: "ตรวจสภาพเสาไฟและอุปกรณ์สื่อสารในพื้นที่ชนบท",
                startMileage: 101769,
                status: "using"
            },

            // 6) ใช้งานจบแล้ว – MU-X สำหรับเดินทางไกล
            {
                id: 6,
                carPlate: "1ขญ-206 กทม",
                ypNo: "ยพ.1206-001",
                mainUser: "นางสาว ณัฐกานต์ ศรีบุญเรือง",
                startDate: "2025-12-20",
                endDate: "2025-12-21",
                destination: "เดินทางไปราชการประชุมเชิงปฏิบัติการ กฟภ.ส่วนกลาง",
                startMileage: 124569,
                endMileage: 125380,
                status: "done"
            }
        ];

        let fuelRecords = [];

        // ===== Helper =====
        function generateYpNumber(carPlate) {
            const nums = carPlate.match(/\d+/g);
            const base = nums ? nums.join("").slice(-4) : "0000";
            const rel = bookings.filter(b => b.carPlate === carPlate);
            if (!rel.length) return `ยพ.${base}-001`;
            const last = rel[rel.length - 1].ypNo;
            const m = last.match(/-(\d{3})$/);
            const seq = (m ? parseInt(m[1], 10) : 0) + 1;
            return `ยพ.${base}-${String(seq).padStart(3, "0")}`;
        }

        // ===== ปฏิทิน =====
        const calendarGrid = document.getElementById("calendarGrid");
        const calendarTitle = document.getElementById("calendarTitle");
        const calendarCarLabel = document.getElementById("calendarCarLabel");
        const carFilter = document.getElementById("carFilter");
        let current = new Date();

        function formatThaiMonthYear(d) {
            const m = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
                "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            return `${m[d.getMonth()]} ${d.getFullYear() + 543}`;
        }

        function renderCalendar() {
            const year = current.getFullYear(), month = current.getMonth();
            calendarTitle.textContent = formatThaiMonthYear(current);
            const selectedCar = carFilter.value;
            calendarCarLabel.textContent = selectedCar === "all" ? "รถทุกคัน" : `ทะเบียน ${selectedCar}`;

            const firstDay = new Date(year, month, 1);
            let startDay = (firstDay.getDay() + 6) % 7; // จันทร์=0
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrev = new Date(year, month, 0).getDate();
            const totalCells = Math.ceil((startDay + daysInMonth) / 7) * 7;
            const today = new Date(); today.setHours(0, 0, 0, 0);

            calendarGrid.innerHTML = "";
            for (let i = 0; i < totalCells; i++) {
                const cell = document.createElement("div");
                cell.className = "calendar-cell";
                let dayNumber, cellDate, isCurrent = true;

                if (i < startDay) {
                    dayNumber = daysInPrev - startDay + i + 1;
                    cellDate = new Date(year, month - 1, dayNumber);
                    cell.classList.add("muted"); isCurrent = false;
                } else if (i >= startDay + daysInMonth) {
                    dayNumber = i - (startDay + daysInMonth) + 1;
                    cellDate = new Date(year, month + 1, dayNumber);
                    cell.classList.add("muted"); isCurrent = false;
                } else {
                    dayNumber = i - startDay + 1;
                    cellDate = new Date(year, month, dayNumber);
                }

                const header = document.createElement("div");
                header.className = "calendar-day-number";
                header.textContent = dayNumber;
                cell.appendChild(header);

                if (isCurrent && cellDate.getTime() === today.getTime()) {
                    cell.classList.add("today");
                }

                const bookingForDay = bookings.filter(b => {
                    if (selectedCar !== "all" && b.carPlate !== selectedCar) return false;
                    const s = new Date(b.startDate), e = new Date(b.endDate);
                    s.setHours(0, 0, 0, 0); e.setHours(0, 0, 0, 0);
                    return cellDate >= s && cellDate <= e;
                });

                bookingForDay.forEach(b => {
                    const car = cars.find(c => c.plate === b.carPlate);
                    const badge = document.createElement("span");
                    badge.className = "badge-booking";
                    badge.style.background = car ? car.color : "#555";
                    badge.innerHTML = `<span>${b.carPlate}</span>`;
                    badge.dataset.bookingId = b.id;
                    badge.addEventListener("click", (ev) => {
                        ev.stopPropagation();
                        showBookingDetail(b.id);
                    });
                    cell.appendChild(badge);
                });

                calendarGrid.appendChild(cell);
            }
        }

        function showBookingDetail(id) {
            const b = bookings.find(x => x.id === id);
            if (!b) return;
            const car = cars.find(c => c.plate === b.carPlate);
            const detailCard = document.getElementById("bookingDetailCard");
            const detailBody = document.getElementById("bookingDetailContent");
            const statusClass = b.status === "using" ? "status-using" : "status-done";
            const statusText = b.status === "using" ? "กำลังใช้งาน" : "คืนแล้ว";

            detailBody.innerHTML = `
            <div class="mb-1"><strong>ทะเบียนรถ:</strong> ${b.carPlate}</div>
            <div class="mb-1"><strong>ยี่ห้อ / รุ่น:</strong> ${car ? car.brand + " " + car.model : "-"}</div>
            <div class="mb-1"><strong>เลข ยพ.:</strong> ${b.ypNo}</div>
            <div class="mb-1"><strong>ผู้ยืม:</strong> ${b.mainUser}</div>
            <div class="mb-1"><strong>วันที่ไป:</strong> ${b.startDate}</div>
            <div class="mb-1"><strong>วันที่กลับ:</strong> ${b.endDate}</div>
            <div class="mb-1"><strong>เลขไมล์ก่อนใช้:</strong> ${b.startMileage || "-"}</div>
            <div class="mb-1"><strong>สถานที่:</strong> ${b.destination || "-"}</div>
            <div class="mb-1">
                <strong>สถานะ:</strong>
                <span class="status-pill ${statusClass}">${statusText}</span>
            </div>
        `;
            detailCard.style.display = "block";
        }

        document.getElementById("prevMonthBtn").addEventListener("click", () => {
            current.setMonth(current.getMonth() - 1);
            renderCalendar();
        });
        document.getElementById("nextMonthBtn").addEventListener("click", () => {
            current.setMonth(current.getMonth() + 1);
            renderCalendar();
        });
        carFilter.addEventListener("change", renderCalendar);

        // ===== Dropdowns & booking form =====
        function initDropdowns() {
            cars.forEach(car => {
                const opt1 = document.createElement("option");
                opt1.value = car.plate;
                opt1.textContent = `${car.plate} (${car.brand} ${car.model})`;
                carFilter.appendChild(opt1);

                const opt2 = opt1.cloneNode(true);
                document.getElementById("carSelect").appendChild(opt2);
            });

            const mainUserSelect = document.getElementById("mainUser");
            users.forEach(u => {
                const opt = document.createElement("option");
                opt.value = u.name;
                opt.textContent = `${u.code} - ${u.name}`;
                mainUserSelect.appendChild(opt);
            });

            updatePassengerDropdowns();
            initFuelDropdown();
        }

        function updatePassengerDropdowns() {
            const count = parseInt(document.getElementById("passengerCount").value, 10) || 1;
            const container = document.getElementById("passengerContainer");
            container.innerHTML = "";
            const extra = Math.max(0, count - 1);
            if (!extra) return;
            const row = document.createElement("div");
            row.className = "row g-2";
            for (let i = 0; i < extra; i++) {
                const col = document.createElement("div");
                col.className = "col-md-4 col-sm-6";
                const label = document.createElement("label");
                label.className = "form-label small";
                label.textContent = `ผู้ร่วมเดินทางคนที่ ${i + 1}`;
                const select = document.createElement("select");
                select.className = "form-select form-select-sm";
                const empty = document.createElement("option");
                empty.value = ""; empty.textContent = "- เลือกผู้ร่วมเดินทาง -";
                select.appendChild(empty);
                users.forEach(u => {
                    const opt = document.createElement("option");
                    opt.value = u.name;
                    opt.textContent = `${u.code} - ${u.name}`;
                    select.appendChild(opt);
                });
                col.appendChild(label); col.appendChild(select);
                row.appendChild(col);
            }
            container.appendChild(row);
        }
        document.getElementById("passengerCount").addEventListener("change", updatePassengerDropdowns);

        document.getElementById("bookingForm").addEventListener("submit", e => {
            e.preventDefault();
            const carPlate = document.getElementById("carSelect").value;
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;
            const mainUser = document.getElementById("mainUser").value;
            const startMileage = document.getElementById("startMileage").value || null;
            const destination = document.getElementById("destination").value || "";

            if (!carPlate || !startDate || !endDate || !mainUser) {
                alert("กรุณากรอกข้อมูลให้ครบ"); return;
            }

            const ypNo = generateYpNumber(carPlate);
            const newBooking = {
                id: bookings.length + 1,
                carPlate, ypNo, mainUser,
                startDate, endDate,
                destination,
                startMileage,
                status: "using"
            };
            bookings.push(newBooking);
            alert(`บันทึกการจองตัวอย่างเรียบร้อย\nเลข ยพ.: ${ypNo}`);

            renderCalendar();
            renderHistoryTable();
            refreshReturnOptions();
        });

        // ===== NAV section =====
        const navLinks = document.querySelectorAll("[data-section-target]");
        function showSection(id) {
            document.querySelectorAll(".app-section").forEach(sec => sec.classList.add("d-none"));
            document.getElementById(id).classList.remove("d-none");
            navLinks.forEach(a => a.classList.remove("active"));
            document.querySelector(`[data-section-target="${id}"]`).classList.add("active");
        }
        navLinks.forEach(a => {
            a.addEventListener("click", e => {
                e.preventDefault();
                showSection(a.dataset.sectionTarget);
            });
        });

        // ===== Return car =====
        const returnSelect = document.getElementById("returnSelect");
        const returnInfo = document.getElementById("returnInfo");
        const returnForm = document.getElementById("returnForm");
        const endMileageInput = document.getElementById("endMileage");

        function refreshReturnOptions() {
            returnSelect.innerHTML = "";
            const using = bookings.filter(b => b.status === "using");
            if (!using.length) {
                returnSelect.innerHTML = `<option value="">ไม่มีรถที่กำลังใช้งาน</option>`;
                returnInfo.style.display = "none";
                returnForm.style.display = "none";
                return;
            }
            returnSelect.innerHTML = `<option value="">- เลือกรถที่กำลังใช้งาน -</option>`;
            using.forEach(b => {
                returnSelect.innerHTML += `<option value="${b.id}">${b.carPlate} (${b.startDate})</option>`;
            });
        }
        returnSelect.addEventListener("change", () => {
            const id = returnSelect.value;
            if (!id) { returnInfo.style.display = "none"; returnForm.style.display = "none"; return; }
            const b = bookings.find(x => x.id == id);
            returnInfo.style.display = "block";
            returnForm.style.display = "block";
            returnInfo.innerHTML = `
            <b>ทะเบียน:</b> ${b.carPlate}<br>
            <b>เลข ยพ.:</b> ${b.ypNo}<br>
            <b>ผู้ยืม:</b> ${b.mainUser}<br>
            <b>วันที่ไป:</b> ${b.startDate}<br>
            <b>สถานที่:</b> ${b.destination || "-"}<br>
            <b>เลขไมล์ก่อนใช้:</b> ${b.startMileage || "-"}
        `;
            endMileageInput.value = "";
        });
        document.getElementById("returnSubmitBtn").addEventListener("click", () => {
            const id = returnSelect.value;
            const b = bookings.find(x => x.id == id);
            if (!b) return;
            b.endMileage = endMileageInput.value || null;
            b.status = "done";
            alert("บันทึกการส่งคืนรถเรียบร้อยแล้ว");
            renderHistoryTable();
            refreshReturnOptions();
            renderCalendar();
        });

        // ===== Fuel =====
        const fuelCar = document.getElementById("fuelCar");
        const fuelMileage = document.getElementById("fuelMileage");
        const fuelPrice = document.getElementById("fuelPrice");
        const fuelLitre = document.getElementById("fuelLitre");
        const fuelTotalInput = document.getElementById("fuelTotal");
        const fuelTableBody = document.querySelector("#fuelTable tbody");

        // คำนวณจำนวนลิตรจากราคาต่อลิตรและราคารวม
        function autoCalcLitre() {
            const price = parseFloat(fuelPrice.value);
            const total = parseFloat(fuelTotalInput.value);

            if (!isNaN(price) && price > 0 && !isNaN(total)) {
                const litre = total / price;
                fuelLitre.value = litre.toFixed(2);   // ปัดทศนิยม 2 ตำแหน่ง
            } else {
                fuelLitre.value = "";
            }
        }

        // เวลาเปลี่ยน "ราคาต่อลิตร" หรือ "ราคารวม" ให้ลองคำนวณใหม่
        fuelPrice.addEventListener("input", autoCalcLitre);
        fuelTotalInput.addEventListener("input", autoCalcLitre);

        function initFuelDropdown() {
            cars.forEach(c => {
                fuelCar.innerHTML += `<option value="${c.plate}">${c.plate}</option>`;
            });
        }

        function renderFuelTable() {
            fuelTableBody.innerHTML = "";
            fuelRecords.forEach(r => {
                fuelTableBody.innerHTML += `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.carPlate}</td>
                    <td>${r.ypNo}</td>
                    <td>${r.mileage}</td>
                    <td>${Number(r.pricePerLitre).toFixed(2)}</td>
                    <td>${Number(r.litre).toFixed(2)}</td>
                    <td>${Number(r.total).toFixed(2)}</td>
                </tr>`;
            });
        }

        document.getElementById("fuelSubmitBtn").addEventListener("click", () => {
            const carPlate = fuelCar.value;
            const mileage = fuelMileage.value;
            const price = fuelPrice.value;
            let litre = fuelLitre.value;
            const total = fuelTotalInput.value;   // ให้ราคารวมเป็นตัวหลัก

            // ต้องมี: ทะเบียนรถ, เลขไมล์, ราคาต่อลิตร, ราคารวม
            if (!carPlate || !mileage || !price || !total) {
                alert("กรุณากรอกทะเบียนรถ เลขไมล์ ราคาน้ำมันต่อลิตร และราคารวมให้ครบ");
                return;
            }

            // ถ้าจำนวนลิตรยังว่างหรือเป็น 0 ให้คำนวณจากราคารวม
            if (!litre || parseFloat(litre) <= 0) {
                const p = parseFloat(price);
                const t = parseFloat(total);
                if (isNaN(p) || p <= 0 || isNaN(t)) {
                    alert("กรุณากรอกราคาน้ำมันต่อลิตรและราคารวมให้ถูกต้อง");
                    return;
                }
                litre = (t / p).toFixed(2);
                fuelLitre.value = litre;   // อัปเดตให้เห็นในฟอร์มด้วย
            }

            const latest = bookings.filter(b => b.carPlate === carPlate).slice(-1)[0];
            const ypNo = latest ? latest.ypNo : "-";
            const todayStr = new Date().toISOString().slice(0, 10);

            fuelRecords.push({
                date: todayStr,
                carPlate,
                ypNo,
                mileage,
                pricePerLitre: price,
                litre,
                total
            });

            renderFuelTable();
            alert(`บันทึกการเติมน้ำมันเรียบร้อย\nเลข ยพ.: ${ypNo}`);

            // ล้างฟอร์มเติมน้ำมัน
            fuelMileage.value = "";
            fuelPrice.value = "";
            fuelLitre.value = "";
            fuelTotalInput.value = "";
        });



        // ===== History table =====
        const historyBody = document.querySelector("#historyTable tbody");
        function renderHistoryTable() {
            historyBody.innerHTML = "";
            bookings.slice().sort((a, b) => a.startDate.localeCompare(b.startDate))
                .forEach(b => {
                    const statusClass = b.status === "using" ? "status-using" : "status-done";
                    const statusText = b.status === "using" ? "กำลังใช้งาน" : "คืนแล้ว";
                    historyBody.innerHTML += `
                    <tr>
                        <td>${b.ypNo}</td>
                        <td>${b.carPlate}</td>
                        <td>${b.mainUser}</td>
                        <td>${b.startDate}</td>
                        <td>${b.endDate}</td>
                        <td>${b.destination || "-"}</td>
                        <td>${b.startMileage || "-"}</td>
                        <td><span class="status-pill ${statusClass}">${statusText}</span></td>
                    </tr>`;
                });
        }

        // ===== Logout =====
        const logoutLink = document.getElementById("logoutLink");
        if (logoutLink) {
            logoutLink.addEventListener("click", e => {
                e.preventDefault();
                localStorage.clear();
                window.location.href = "login.html";
            });
        }

        // ===== INIT =====
        function init() {
            initDropdowns();
            renderCalendar();
            renderHistoryTable();
            renderFuelTable();
            refreshReturnOptions();
            showSection("section-calendar");
            console.log("LOGIN USER:", sessionEmpCode, sessionEmpName);
        }
        init();
    </script>
</body>

</html>